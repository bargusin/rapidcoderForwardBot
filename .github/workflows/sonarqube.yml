name: SonarCloud PR Analysis
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  analyze:
    name: SonarCloud PR Analysis
    runs-on: ubuntu-latest

    # –¢–æ–ª—å–∫–æ –¥–ª—è PR –≤ main
    if: |
      github.event.pull_request.base.ref == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Debug SonarCloud configuration
        run: |
          echo "üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
          echo "SONAR_ORGANIZATION: '${{ secrets.SONAR_ORGANIZATION }}'"
          echo "SONAR_PROJECT_KEY: '${{ secrets.SONAR_PROJECT_KEY }}'"
          echo "SONAR_TOKEN: ${{ secrets.SONAR_TOKEN != '' }}"

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –ø—É—Å—Ç—ã–µ
          if [ -z "${{ secrets.SONAR_ORGANIZATION }}" ]; then
            echo "‚ùå CRITICAL: SONAR_ORGANIZATION is EMPTY!"
            echo "üí° Set it in GitHub Secrets ‚Üí Actions"
            exit 1
          fi

          if [ -z "${{ secrets.SONAR_PROJECT_KEY }}" ]; then
            echo "‚ùå CRITICAL: SONAR_PROJECT_KEY is EMPTY!"
            echo "üí° Set it in GitHub Secrets ‚Üí Actions"
            exit 1
          fi

          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "‚ùå CRITICAL: SONAR_TOKEN is EMPTY!"
            echo "üí° Generate token at: https://sonarcloud.io/account/security/"
            exit 1
          fi
          echo "‚úÖ All secrets are configured"

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: '8.5'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Cache SonarQube packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ github.event.pull_request.number }}
          restore-keys: ${{ runner.os }}-sonar-

      - name: Build and test
        run: |
          gradle clean build jacocoTestReport

      - name: SonarCloud Scan
        if: github.event_name == 'pull_request'
        run: |
          gradle sonar \
            -Dsonar.analysis.ci=true \
            -Dsonar.gradle.skipCompile=true \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml \
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
            -Dsonar.pullrequest.branch=${{ github.event.pull_request.head.ref }} \
            -Dsonar.pullrequest.base=${{ github.event.pull_request.base.ref }} \
            -Dsonar.pullrequest.provider=github \
            -Dsonar.pullrequest.github.repository=${{ github.repository }} \
            -Dsonar.qualitygate.wait=true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Quality Gate status
        id: quality-gate
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        with:
          scanMetadataReportFile: build/sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Comment PR with analysis result
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const qualityGateStatus = '${{ steps.quality-gate.outputs.quality-gate-status }}';
            const dashboardUrl = '${{ steps.quality-gate.outputs.dashboard-url }}';
            
            let commentBody = '';
            let emoji = 'üîç';
            
            if (qualityGateStatus === 'OK') {
              emoji = '‚úÖ';
              commentBody = `
              ${emoji} **SonarCloud Quality Gate –ø—Ä–æ–π–¥–µ–Ω–∞!**
            
              –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ. –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.
            
              [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç](${dashboardUrl})
              `;
            } else if (qualityGateStatus === 'ERROR') {
              emoji = '‚ùå';
              commentBody = `
              ${emoji} **SonarCloud Quality Gate –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞!**
            
              –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –ø–µ—Ä–µ–¥ –º–µ—Ä–∂–µ–º.
            
              [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—ã](${dashboardUrl})
              `;
            } else {
              commentBody = `
              ${emoji} **SonarCloud –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω**
            
              –°—Ç–∞—Ç—É—Å: ${qualityGateStatus}
            
              [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç](${dashboardUrl})
              `;
            }
            
            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –±–æ—Ç–∞
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.body.includes('SonarCloud') && 
              comment.user.type === 'Bot'
            );
            
            if (botComment) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }